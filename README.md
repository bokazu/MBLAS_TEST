# MBLAS.h(状態行列演に対する線形代数演算library)

1. [概要](#1-概要)
2. [関数一覧](#2-関数一覧)
3. [ベンチマーク](#3ベンチマーク)

## 1. 概要
---
量子スピン系において、状態ベクトルをテンソル積を利用して状態行列として扱うことができる。この状態行列に対して、状態ベクトルに対して行う線形代数演算と等価な演算を行うためのAPIをMBLAS.hは提供する(OpenMPによるスレッド並列化を施した関数も提供している)。MBLAS.hは基本的に倍精度実数をサポートしている。また、本libraryで提供している演算とそれを利用するための関数名は以下の表のとおりになっている。

## 2. 関数一覧
|演算|関数名|説明|
|---|-------|----|
|**内積計算**|**mm_ddot**|**2つのベクトルの内積計算$\vec{v}_1\cdot \vec{v}_2$に対応する**|
|            |MP_mm_ddot|上記の関数についてOpenMPを用いた並列化を施した関数|
|            |MP_schedule_mm_ddot|上記の関数についてOpenMPを用い、さらにOpenMPのscheduling機能を利用した関数|
|**代入計算**|**mm_dcopy**|**片方のベクトルをもう片方のベクトルに代入する演算$\vec{v}_2 = \vec{v}_1$に対応する**|
|             |MP_mm_dcopy|上記の関数についてOpenMPを用いた並列化を施した関数|
||MP_schedule_mm_dcopy|上記の関数についてOpenMPを用い、さらにOpenMPのscheduling機能を利用した関数|
|**定数倍**|**mm_dscal**|**ベクトルの定数倍$\vec{v}_1 = \alpha \vec{v}_1$に対応する**|
|          |MP_mm_dscal|上記の関数についてOpenMPを用いた並列化を施した関数|
|          |MP_schedule_mm_dscal|上記の関数についてOpenMPを用い、さらにOpenMPのscheduling機能を利用した関数|
|**和**|**mm_daxpy**|**2つのベクトルについて片方を定数倍したものをもう片方に加える演算$\vec{v}_2 += \alpha \vec{v}_1$を行う**|
|      |MP_mm_daxpy|上記の関数についてOpenMPを用いた並列化を施した関数|
|      |MP_schedule_mm_daxpy|上記の関数についてOpenMPを用い、さらにOpenMPのscheduling機能を利用した関数|
|**ノルム計算**|**mm_dnrm2**|L2ノルム計算$\|\vec{v}\|$に対応する|
|              |MP_mm_dnrm2|上記の関数についてOpenMPを用いた並列化を施した関数|
|              |MP_schedule_mm_dnrm2|上記の関数についてOpenMPを用い、さらにOpenMPのscheduling機能を利用した関数|
|**規格化**|**mm_sdz**|**ベクトルの規格化に対応する計算を行う**|
||MP_mm_sdz|上記の関数についてOpenMPを用いた並列化を施した関数|
||MP_schedule_mm_sdz|上記の関数についてOpenMPを用い、さらにOpenMPのscheduling機能を利用した関数|

## 3.ベンチマーク
OpenMPを用いた並列化を行った場合とそうでない場合とで計算結果や計算時間がどうなるのかを比較した。その結果を以下にまとめる。なお、計算環境は次のとおりである。
- OS : Ubuntu 20.04 LTS
- CPU : intel i7-12700 (計算時には20スレッドで並列化を行った)
- メモリ : Essensecore KLevv DDR4 U-DIMM (32GB x 4)

1. **mm_ddot, MP_mm_ddot, MP_schedule_mm_ddotの比較**

    5e04 x 5e04サイズの実正方行列を1つ密行列形式で用意し、その行列の内積計算を上記の3つの関数に10回ずつ計算させた。その計算結果は以下のとおりである。10桁精度で一致している。

    ||mm_ddot|MP_mm_ddot|MP_schedule_mm_ddot|
    |---|-------------------|-------------------|-------------------|
    |1回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |2回目|624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |3回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |4回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |5回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |6回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |7回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |8回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |9回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    |10回目| 624.9825172200483 | 624.9825172201482 | 624.9825172201482 |
    
    また、計算時間は次のようになった。単位はいずれもミリ秒である。
    
    || mm_ddot | MP_mm_ddot |MP_schedule_mm_ddot|
    |---|--------|----------------------------|------|
    |1回目|   1211 |  1021 | 1012 |
    |2回目|   1195 |  1073 | 1095 |
    |3回目|   1271 |  1043 | 1036 |
    |4回目|   1221 |  1014 | 1008 |
    |5回目|   1182 | 1008 | 1014 |
    |6回目|   1179 |  1013 | 1014 |
    |7回目|   1180 | 1014 | 1011 |
    |8回目|   1177 | 1012 | 1009 |
    |9回目|   1176 | 1014 | 1011 |
    |10回目|   1175 |1013 | 1011 |


2. **mm_dcopy, MP_mm_dcopy, MP_schedule_mm_dcopy**

     5e04 x 5e04サイズの実正方行列を2つ密行列形式で用意し、その行列の片方をもう片方に代入させた。上記の3つの関数に10回ずつ計算させた。successであれば、すべての行列要素が代入元と代入先とで一致していることを表す。

    ||mm_dcopy|MP_mm_dcopy|MP_schedule_mm_dcopy|
    |---|-------------------|-------------------|-------------------|
    |1回目|success|success|success|
    |2回目|success|success|success|
    |3回目|success|success|success|
    |4回目|success|success|success|
    |5回目|success|success|success|
    |6回目|success|success|success|
    |7回目|success|success|success|
    |8回目|success|success|success|
    |9回目|success|success|success|
    |10回目|success|success|success|

    また、計算時間は次のようになった。単位はいずれもミリ秒である。
    ||mm_dcopy|MP_mm_dcopy|MP_schedule_mm_dcopy|
    |---|-------------------|-------------------|-------------------|
    |1回目|1608|1071|1081|
    |2回目|1601|1074|1067|
    |3回目|1604|1087|1066|
    |4回目|1603|1077|1068|
    |5回目|1604|1078|1078|
    |6回目|1601|1069|1065|
    |7回目|1605|1067|1068|
    |8回目|1615|1074|1086|
    |9回目|1644|1077|1063|
    |10回目|1601|1078|1069|

3. **mm_dscal, MP_mm_dscal, MP_schedule_mm_dscal**
    
    5e04 x 5e04サイズの実正方行列を密行列形式で用意し、その行列を定数倍した。上記の3つの関数に10回ずつ計算させた。successであれば、並列化をほどこした関数とそうでない関数とで結果が一致していることを表す。

    ||mm_dscal|MP_mm_dscal|MP_schedule_mm_dscal|
    |---|-------------------|-------------------|-------------------|
    |1回目|success|success|success|
    |2回目|success|success|success|
    |3回目|success|success|success|
    |4回目|success|success|success|
    |5回目|success|success|success|
    |6回目|success|success|success|
    |7回目|success|success|success|
    |8回目|success|success|success|
    |9回目|success|success|success|
    |10回目|success|success|success|


    また、計算時間は次のようになった。単位はいずれもミリ秒である。
    ||mm_dscal|MP_mm_dscal|MP_schedule_mm_dscal|
    |---|-------------------|-------------------|-------------------|
    |1回目|1116|992|991|
    |2回目|1114|990|990|
    |3回目|1113|990|990|
    |4回目|1112|990|990|
    |5回目|1111|990|992|
    |6回目|1112|991|990|
    |7回目|1111|990|989|
    |8回目|1112|990|989|
    |9回目|1111|991|990|
    |10回目|1111|990|990|


4. **mm_daxpy, MP_mm_daxpy, MP_schedule_mm_daxpy**

    1e04 x 1e04サイズの実正方行列を2つ密行列形式で用意し、その行列の片方を0.5倍にしもう片方に足した。上記の3つの関数に10回ずつ計算させた。行列要素のうち、(1,3)成分と(10,10)成分を結果確認用に利用する。

    ### @(1,3)成分

    ||mm_daxpy|MP_mm_daxpy|MP_schedule_mm_daxpy|
    |---|-------------------|-------------------|-------------------|
    |1回目||
    |2回目||
    |3回目||
    |4回目||
    |5回目||
    |6回目||
    |7回目||
    |8回目||
    |9回目||
    |10回目||

    ### (10,10)成分

    ||mm_daxpy|MP_mm_daxpy|MP_schedule_mm_daxpy|
    |---|-------------------|-------------------|-------------------|
    |1回目||
    |2回目||
    |3回目||
    |4回目||
    |5回目||
    |6回目||
    |7回目||
    |8回目||
    |9回目||
    |10回目|


     また、計算時間は次のようになった。単位はいずれもミリ秒である。
    ||mm_daxpy|MP_mm_daxpy|MP_schedule_mm_daxpy|
    |---|-------------------|-------------------|-------------------|
    |1回目||
    |2回目||
    |3回目||
    |4回目||
    |5回目||
    |6回目||
    |7回目||
    |8回目||
    |9回目||
    |10回目||


5. **mm_dnrm2, MP_mm_dnrm2, MP_schedule_mm_dnrm2** 

     5e04 x 5e04サイズの実正方行列を密行列形式で用意し、その行列のノルム計算を行った。上記の3つの関数に10回ずつ計算させた。
    ||mm_dnrm2|MP_mm_dnrm2|MP_schedule_mm_dnrm2|
    |---|-------------------|-------------------|-------------------|
    |1回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |2回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |3回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |4回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |5回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |6回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |7回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |8回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |9回目|28.86732751023326|28.86732751023517|28.86732751023517|
    |10回目|28.86732751023326|28.86732751023517|28.86732751023517|


    また、計算時間は次の通りになった。
    ||mm_dnrm2|MP_mm_dnrm2|MP_schedule_mm_dnrm2|
    |---|-------------------|-------------------|-------------------|
    |1回目|713|495|494|
    |2回目|710|496|493|
    |3回目|711|497|495|
    |4回目|712|495|493|
    |5回目|709|496|494|
    |6回目|712|495|495|
    |7回目|713|495|494|
    |8回目|707|495|496|
    |9回目|713|496|495|
    |10回目|712|495|495|


6. **mm_sdz, MP_mm_sdz, MP_schedule_mm_sdz**

    5e04 x 5e04サイズの実正方行列を密行列形式で用意し、その行列の規格化を行った。上記の3つの関数に10回ずつ計算させた。行列要素のうち、(1,3)成分と(10,10)成分を結果確認用に利用する。

    ### @(1,3)成分

    ||mm_sdz|MP_mm_sdz|MP_schedule_mm_sdz|
    |---|-------------------|-------------------|-------------------|
    |1回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |2回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |3回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |4回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |5回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |6回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |7回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |8回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |9回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|
    |10回目|3.430225821900874e-05|3.430225821900415e-05|3.430225821900415e-05|

    ### (10,10)成分

    ||mm_sdz|MP_mm_sdz|MP_schedule_mm_sdz|
    |---|-------------------|-------------------|-------------------|
    |1回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |2回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |3回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |4回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |5回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |6回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |7回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |8回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |9回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|
    |10回目|3.059049713752127e-05|3.059049713751718e-05|3.059049713751718e-05|


    また、計算時間は次のようになった。単位はいずれもミリ秒である。
    ||mm_sdz|MP_mm_sdz|MP_schedule_mm_sdz|
    |---|-------------------|-------------------|-------------------|
    |1回目|1902|1485|1479|
    |2回目|1895|1483|1487|
    |3回目|1896|1481|1480|
    |4回目|1904|1484|1479|
    |5回目|1894|1479|1479|
    |6回目|1903|1481|1480|
    |7回目|1903|1481|1479|
    |8回目|1904|1480|1478|
    |9回目|1894|1484|1481|
    |10回目|1891|1483|1479|